@page
@model TrafficLawDocumentRazor.Pages.LawDocumentPage.DetailsModel

@{
    ViewData["Title"] = "Details";
}
@**
<h1>Details</h1>

<div>
    <h4>LawDocument</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.Title)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.Title)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.DocumentCode)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.DocumentCode)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.FilePath)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.FilePath)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.LinkPath)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.LinkPath)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.ExpertVerification)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.ExpertVerification)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.CreatedBy)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.CreatedBy)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.LastUpdatedBy)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.LastUpdatedBy)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.DeletedBy)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.DeletedBy)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.CreatedTime)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.CreatedTime)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.LastUpdatedTime)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.LastUpdatedTime)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.DeletedTime)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.DeletedTime)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.LawDocument.Category)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.LawDocument.Category.Id)
        </dd>
    </dl>
</div>
<div>
    <a asp-page="./Edit" asp-route-id="@Model.LawDocument.Id">Edit</a> |
    <a asp-page="./Index">Back to List</a>
</div>
 *@

@{
    ViewData["Title"] = "Details";
}
@section Styles {
    <link rel="stylesheet" href="~/css/site2.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
}
    <div class="page-wrapper">
        <div class="main custom-main">
            <div class="main-content">
                <div class="breadcrumb">
                    Home / Law Documents / Details
                </div>
                <div>
                    <h1>@Model.LawDocument.Title</h1>
                </div>
                <div class="container">
                    <div class="main">
                        <div class="tabs">
                            <button class="active" data-tab="summary">Summary</button>
                            <button data-tab="content">Content</button>
                            <button data-tab="status">Status</button>
                            <button data-tab="download">Download</button>
                        </div>

                        <div class="tab-content" id="summary" style="display: block">
                            <div class="legal-wrapper">
                                <div class="summary-section">
                                    <h2>ATTRIBUTE</h2>
                                    <p><strong>@Model.LawDocument.Title</strong></p>
                                    <table class="summary-table">
                                        <tr>
                                            <td><strong>Document Code:</strong></td>
                                            <td>@Model.LawDocument.DocumentCode</td>
                                            <td><strong>Expert Verified:</strong></td>
                                            <td class="status-known">@(Model.LawDocument.ExpertVerification ? "Yes" : "No")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Category:</strong></td>
                                            <td>@Model.LawDocument.Category?.Name</td>
                                            <td><strong>Created:</strong></td>
                                            <td>@Model.LawDocument.CreatedTime?.ToString("dd/MM/yyyy")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Created By:</strong></td>
                                            <td>@Model.LawDocument.CreatedBy</td>
                                            <td><strong>Last Updated:</strong></td>
                                            <td>@Model.LawDocument.LastUpdatedTime?.ToString("dd/MM/yyyy")</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="content" style="display: none">
                            <div class="legal-wrapper">
                                <p>Document Link: <a href="@Model.LawDocument.LinkPath" target="_blank">@Model.LawDocument.LinkPath</a></p>
                                // <embed src="~/files/135-2025-ND-CP.pdf" type="application/pdf" width="100%" height="800px" />
                                <embed src="@Model.LawDocument.FilePath" type="application/pdf" width="100%" height="800px" />
                            </div>
                        </div>

                        <div class="tab-content" id="status" style="display: none">
                            <p>Status: @(Model.LawDocument.DeletedTime.HasValue ? "Deleted" : "Active")</p>
                        </div>

                        <div class="tab-content" id="download" style="display: none">
                            <div class="legal-wrapper">
                                <div class="download-buttons">
                                    @functions {
                                        public static string GenerateSafeFileName(string rawTitle)
                                        {
                                            // Normalize and strip diacritics (accents)
                                            string normalized = rawTitle.Normalize(System.Text.NormalizationForm.FormD);
                                            var sb = new System.Text.StringBuilder();
                                            foreach (var ch in normalized)
                                            {
                                                var uc = System.Globalization.CharUnicodeInfo.GetUnicodeCategory(ch);
                                                if (uc != System.Globalization.UnicodeCategory.NonSpacingMark)
                                                {
                                                    sb.Append(ch);
                                                }
                                            }

                                            string noAccents = sb.ToString().Normalize(System.Text.NormalizationForm.FormC);

                                            // Replace Vietnamese-specific characters
                                            noAccents = noAccents.Replace("đ", "d").Replace("Đ", "D");

                                            // Replace everything not allowed in filenames with underscore
                                            string cleaned = System.Text.RegularExpressions.Regex.Replace(noAccents, @"[^a-zA-Z0-9\-_.]+", "_");

                                            // Remove leading/trailing underscores
                                            return cleaned.Trim('_');
                                        }
                                    }

                                    @{
                                        var safeFileName = GenerateSafeFileName(Model.LawDocument.Title) + ".pdf";
                                    }

                                    <button class="btn-download pdf" onclick="downloadFile('@Model.LawDocument.FilePath', '@safeFileName')">
                                        <i class="fas fa-file-pdf"></i> Download as PDF
                                    </button>
                                    <button class="btn-download word" onclick="downloadFile('@Model.LawDocument.FilePath.Replace(".pdf", ".docx")', 'document.docx')">
                                        <i class="fas fa-file-word"></i> Download as Word
                                    </button>
                                </div>
                            </div>
                        </div>

                        


                    </div>

                    <aside class="sidebar">
                        <h4>MOST VIEWED</h4>
                        <div class="box most-viewed">
                            <ul class="most-viewed-list">
                                <li>Placeholder document 1</li>
                                <li>Placeholder document 2</li>
                            </ul>
                        </div>
                    </aside>
                </div>
            </div>
       
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const tabs = document.querySelectorAll(".tabs button");
            const contents = document.querySelectorAll(".tab-content");

            tabs.forEach((tab) => {
                tab.addEventListener("click", function () {
                    tabs.forEach((t) => t.classList.remove("active"));
                    this.classList.add("active");
                    contents.forEach((c) => (c.style.display = "none"));
                    const selectedTab = this.getAttribute("data-tab");
                    document.getElementById(selectedTab).style.display = "block";
                });
            });
        });
    </script>

    <script>
        function downloadFile(fileUrl, fileName) {
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok.");
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.style.display = "none";
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    alert("Failed to download file: " + error);
                    console.error("Download error:", error);
                });
        }
    </script>
